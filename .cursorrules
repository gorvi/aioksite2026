# 项目开发规范

## 技术栈
- **前端框架**: Next.js 14+ (App Router)
- **语言**: TypeScript
- **样式**: Tailwind CSS
- **数据库**: MySQL (通过 MCP)
- **图表库**: recharts

## 代码风格

### 命名规范
- **常量名**: 全大写，用下划线分隔，如 `SCL90_TOTAL_QUESTIONS`
- **函数名**: 小驼峰命名法，如 `calculateScl90Result`
- **组件名**: 大驼峰命名法，如 `LineChartComponent`
- **文件名**: 
  - 组件文件使用大驼峰，如 `LineChart.tsx`
  - 工具函数使用小驼峰，如 `scl90-calculator.ts`
  - 页面文件使用小写，如 `page.tsx`

### TypeScript
- 严格模式，所有类型必须明确定义
- 使用 `interface` 定义对象类型
- 使用 `type` 定义联合类型或别名
- 导出类型使用 `export type` 或 `export interface`

## 公共组件和功能复用

### 1. 折线图组件 (`src/components/common/LineChart.tsx`)

**用途**: 统一的折线图组件，用于展示测试结果得分趋势

**使用方式**:
```typescript
import LineChartComponent from '@/components/common/LineChart';

<LineChartComponent
  data={[
    { name: '因子1', score: 2.5 },
    { name: '因子2', score: 3.0 },
    // ...
  ]}
  yAxisLabel="得分"
  yAxisDomain={[0, 5]}
  height={320}
  showThreshold={true}
  thresholdValue={2.0}
  thresholdLabel="得分 ≥ 2.0 通常提示需关注"
/>
```

**特性**:
- Y轴标签显示在图表上方（倾斜显示）
- 横轴左右边距一致（各10px）
- 数据点上显示倾斜的分数标签（-45度）
- 支持自定义Y轴范围、高度、阈值提示
- 统一的样式和交互体验

**Props说明**:
- `data`: 数据数组，每个元素包含 `name` 和 `score`
- `yAxisLabel`: Y轴标签（默认"得分"）
- `yAxisDomain`: Y轴范围（默认[0, 5]）
- `height`: 图表高度（默认320px）
- `showThreshold`: 是否显示阈值提示（默认true）
- `thresholdValue`: 阈值数值（默认2.0）
- `thresholdLabel`: 阈值提示文字

**注意事项**:
- 所有测试结果的折线图都应使用此组件，保持样式一致
- 如需自定义样式，优先通过props配置，避免直接修改组件

### 2. 昵称输入组件 (`src/components/common/NicknameInput.tsx`)

**用途**: 统一的昵称输入组件，带实时验证

**使用方式**:
```typescript
import NicknameInput from '@/components/common/NicknameInput';

<NicknameInput
  onSubmit={(nickname) => {
    // 处理提交
  }}
  onBack={() => router.back()}
  backUrl="/previous-page"
  title="输入昵称"
  subtitle="请输入您的昵称（3-15位字母或字母+数字，不能是纯数字）"
/>
```

**验证规则**:
- 长度：3-15个字符
- 只能包含字母（a-z, A-Z）和数字（0-9）
- 必须包含至少一个字母（不能是纯数字）
- 不能包含空格、特殊字符或中文

### 3. 其他公共组件

- `Button`: 统一按钮组件，支持多种变体和尺寸
- `Card`: 统一卡片组件
- `Header`: 统一导航栏组件
- `Disclaimer`: 统一免责声明组件
- `CuteDecoration`: 随机可爱装饰元素组件

## 数据库

### 表结构
- `serial_numbers`: 序列号表
- `scl90_tests`: SCL-90测试记录表
- `scl90_answers`: SCL-90答案表
- `adhd_tests`: ADHD测试记录表
- `adhd_answers`: ADHD答案表

### 数据库操作
- 使用 MCP MySQL 进行数据库操作
- 所有数据库操作封装在 `src/lib/db/mcp-mysql.ts`
- 类型定义在 `src/types/index.ts`

## API设计

### RESTful API
- 使用标准HTTP方法（GET, POST, PUT, DELETE）
- 返回JSON格式数据
- 错误处理统一格式

## 合规要求（重要要求）

### 文本规范（必须严格遵守）
- **免责声明**：所有测试结果页面必须包含明确的免责声明
- **术语使用**：
  - 使用"仅供自我了解使用"而非"专业诊断"
  - 避免使用"阳性"等医学术语，改用"需关注"等中性表述
  - 建议咨询时使用"医疗机构或心理健康从业者"而非"专业医生"
- **报告命名**：使用"倾向自测"而非"模拟"或"诊断"
- **结果表述**：避免使用"确诊"、"诊断"等医疗术语，使用"提示"、"建议关注"等中性表述

### 用户同意（必须严格遵守）
- 所有测试开始前必须获得用户同意
- 使用明确的勾选框确认
- 提供《个人心理健康敏感信息处理同意书》链接
- 同意书必须可点击查看，并在新标签页打开
- 返回逻辑必须正确，能返回到打开同意书的页面

## 开发流程

1. **功能开发前**: 先检查是否有可复用的公共组件或功能
2. **组件创建**: 如果功能可能被复用，创建公共组件
3. **文档更新**: 更新 `.cursorrules` 记录新的公共功能
4. **代码审查**: 确保符合命名规范和代码风格
5. **测试**: 确保功能正常且样式统一

## 样式规范（通用要求）

### Tailwind CSS
- 优先使用 Tailwind 工具类
- 自定义样式放在 `globals.css`
- 支持暗色模式（使用 `dark:` 前缀）

### 响应式设计（通用要求）
- 移动端优先
- 使用 `sm:`, `md:`, `lg:` 等断点
- 确保所有页面在移动端和桌面端都能正常显示

### UI一致性（通用要求）
- 所有按钮使用统一的 `Button` 组件
- 所有卡片使用统一的 `Card` 组件
- 所有页面使用统一的 `Header` 组件
- 图标使用 Material Symbols，保持风格一致
- 颜色方案统一，使用 Tailwind 预设颜色
- 间距和圆角统一，使用 Tailwind 标准值

### 交互一致性（通用要求）
- 所有返回按钮行为一致
- 所有提交按钮加载状态一致
- 所有表单验证反馈一致
- 所有错误提示样式一致

## 开发原则（重要）

### 核心原则
1. **强调的要求**：所有强调的要求（如合规、一致性、用户体验等）必须严格遵守，并在 `.cursorrules` 中明确记录
2. **通用的要求**：通用的功能、样式、交互模式等应统一规范，避免重复实现
3. **复用的都抽象**：任何可能被复用的功能、组件、工具函数都应抽象为公共组件或工具函数

### 实施流程
- 开发新功能前，先检查 `.cursorrules` 中是否有相关规范或可复用组件
- 发现通用需求时，立即抽象为公共组件/工具函数
- 更新 `.cursorrules` 记录新的公共功能和使用规范
- 确保所有强调的要求在代码中都有体现

## 测试结果导出

### 图片导出（重要要求）

**核心原则**：导出的图片必须与页面显示完全一致

**技术要求**:
- 使用 `html2canvas` 库进行截图
- 导出函数在 `src/lib/utils/export-result.ts`
- 必须确保以下一致性：
  - **样式一致性**：字体、颜色、间距、圆角、阴影等必须与页面一致
  - **布局一致性**：元素位置、大小、对齐方式必须与页面一致
  - **内容一致性**：所有可见内容（文字、图表、装饰元素）必须完整显示
  - **背景一致性**：背景色、背景图必须与页面一致

**实现要点**:
- **滚动处理**：导出前滚动到元素顶部，确保所有内容可见
- 等待字体加载完成（`document.fonts.ready`）
- **SVG 图表特殊处理**：
  - 检测是否有 SVG 元素（recharts 图表）
  - 等待额外时间（500ms）确保 SVG 完全渲染，包括所有标签和动画
  - 在 `onclone` 回调中确保 SVG 及其内部元素（text、g 等）可见
  - 启用 `foreignObjectRendering: true` 以支持 SVG 渲染
  - 确保 LabelList 的分数标签在克隆文档中可见
- **尺寸计算**：
  - 使用 `getBoundingClientRect()` 和 `scrollWidth/scrollHeight` 获取完整尺寸
  - 使用 `Math.max()` 确保取最大值，避免内容被裁剪
  - 在 `onclone` 中设置元素的完整宽高和 `overflow: visible`
  - 设置 `windowWidth` 和 `windowHeight` 确保捕获所有内容
- 正确检测和应用背景色
- 使用 `onclone` 回调确保克隆文档中的样式正确
- 在 `onclone` 中确保所有子元素的 `overflow` 不为 `hidden`
- 设置合适的 `scale` 值（建议 2）提高图片质量
- 确保所有动态内容（如随机 emoji）在导出时已渲染完成

**注意事项**:
- 导出元素必须设置明确的 `id`（如 `result-card`）
- 避免使用 `overflow-hidden`，使用 `overflow-visible` 确保内容完整显示
- 装饰元素（如 `CuteDecoration`）应包含在导出范围内
- **图表（如折线图）必须完整渲染，包括所有标签和数据点**：
  - 确保折线图上的分数标签（LabelList）在导出图片中可见
  - 检查 SVG 元素及其子元素（text、g）的 visibility 和 opacity
  - 确保所有图表元素（坐标轴、网格、数据点、标签）都正确显示
- **一致性检查清单**：
  - 折线图分数标签是否显示
  - 装饰元素（emoji）是否显示
  - 所有文字内容是否完整
  - 背景色和样式是否一致
  - 图表布局是否一致
- 测试时务必对比导出图片和页面显示，确保完全一致

### 分享功能
- 使用 Web Share API
- 降级方案：复制链接或下载图片
- 分享的图片必须与导出图片一致

